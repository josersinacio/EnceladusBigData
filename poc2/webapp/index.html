<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Signika:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <title>Enceladus Big Data</title>
</head>

<body>
  <section class="novoPedido--section">

    <h2 class="Signika--700">Solicitar Novo Relatório</h2>
    <div class="relatorioTipo">
      <label class="Signika--500">Tipo de Relatório: Mortalidade por queimadura</label>
    </div>
    <br>
    <form onsubmit="processar(); return false;" class="novoPedido--form">
      <label class="novoPedido--label Signika--300">
        Estado

        <select id="estadosSelect" required>
          <option>Selecione</option>
        </select>
      </label>
      
      <label class="novoPedido--label Signika--300">
        Data inicial

        <input id="dataInicialInput" type="date" min="2013-01-01" max="2019-12-31" required>
      </label>

      <label class="novoPedido--label Signika--300">
        Data final

        <input id="dataFinalInput" type="date" min="2013-01-01" max="2019-12-31" required>
      </label>

      <label class="novoPedido--label Signika--300">
        E-mail

        <input id="emailInput" type="email" required>
      </label>

      <button type="submit" class="Signika--500">Processar</button>
    </form>
  </section>

  <section class="relatoriosProcessados--section">
    <h2  class="Signika--700">Relatórios Processados</h2>

    <table class="relatoriosProcessados--table">

      <tr class="Signika--500">
        <th>Estado</th>
        <th>Data de Inicio</th>
        <th>Data de Fim</th>
        <th>Download</th>
      </tr>

      <tbody id="linhasProcessadas"></body>

    </table>
  </section>

<div id="criadoPor" class="modalDialog">
  <div>
    <a href="#fecharPopup" title="Close" class="close">X</a>
    <h2 class="Signika--700">Desenvolvido por:</h2>
    <p>José Rodrigo Inácio | 
      <a class="social--links" href="https://github.com/josersi" target="_blank">Github</a> - 
      <a class="social--links" href="https://www.linkedin.com/in/josersinacio/" target="_blank">LinkedIn</a>
    </p>
    <p>Josué de Paulo Viana | 
      <a class="social--links" href="https://github.com/josuepviana" target="_blank">Github</a> -
      <a class="social--links" href="https://www.linkedin.com/in/josue-viana/" target="_blank">LinkedIn</a>
    </p>
  </div>
</div>

<div id="comoUsar" class="modalDialog">
  <div>
    <a href="#fecharPopup" title="Close" class="close">X</a>
    <h2 class="Signika--700">Como usar:</h2>
    <h3 class="Signika--500">Tipo de Relatório</h3>
    <p>É onde você escolhe o tipo de relatório que quer visualizar.</p>
    <h3 class="Signika--500">Opções de Dados</h3>
    <p>Você pode escolher o <i><b>estado</b></i> e as <i><b>data de inicio</b></i> e <i><b>fim dos dados</b></i> que serão utilizados no relatório. 
      Para que você receba o relatório, seu e-mail deve ter sido cadastrado previamente.
      Se ainda não é cadastrado, favor entrar em contato com os desenvolvedores.</p>
    <h3 class="Signika--500">Relatórios Processados</h3>
    <p>A tabela exibe os relatórios processados anteriormente e os dados utilizados para gera-los.</p>
  </div>
</div>

  <footer class="Signika--500">
    <div><a class="social--links" href="#comoUsar">Como usar</a> | <a class="social--links" href="#criadoPor">Criado por</a></div>
    <div>&copy; Copyright 2021, Enceladus Big Data</div>
  </footer>

  <script>
    const baseUrl = 'http://ec2-3-21-234-58.us-east-2.compute.amazonaws.com:5000';

    window.addEventListener('load', async () => {
      
      await atualizarTabela();

      setInterval(atualizarTabela, 2000);    
      
      for (const estado of getEstados()) {
        const estadoOption = document.createElement("option");

        estadoOption.value = estado.sigla;
        estadoOption.innerText = estado.nome;

        estadosSelect.appendChild(estadoOption);
      }
    })

    async function atualizarTabela() {
      const relatorios = await buscarRelatoriosProcessados();

      linhasProcessadas.innerHTML = '';

      relatorios.forEach(relatorio => {

        const dataInicial = formatarDate(relatorio.data_inicio);
        const dataFinal = formatarDate(relatorio.data_fim);

        linhasProcessadas.innerHTML += `
        <tr>
          <td class="estadoProcessado Signika--300">${relatorio.estado}</td>
          <td class="dataInicioProcessado Signika--300">${dataInicial}</td>
          <td class="dataFimProcessado Signika--300">${dataFinal}</td>
          <td class="downloadProcessado Signika--300"><a href='${baseUrl + relatorio.uri}'> Baixar PDF </a></td> 
        </tr>`;
      });
    }

    async function processar() {
      const enviarForm = new URL(`${baseUrl}/relatorios/queimaduras/densidade-municipal-por-periodo`);

      enviarForm.searchParams.append("estado", estadosSelect.value);
      enviarForm.searchParams.append("data_inicio", dataInicialInput.value);
      enviarForm.searchParams.append("data_fim", dataFinalInput.value);
      enviarForm.searchParams.append("email", emailInput.value);

      try {
        const response = await fetch(enviarForm.href, { method: 'POST' });
        const body = await response.json();

        alert(`Relatório enviado para processamento!\nCódigo: ${body.id_requisicao}`);
      } catch (ex) {
        alert('Erro ao processar relatório!');
      } 
    }

    async function buscarRelatoriosProcessados() {
      const response = await fetch(`${baseUrl}/relatorios/queimaduras/densidade-municipal-por-periodo/processados`);

      return response.json();
    }

    function formatarDate(dateString) {
      const date = new Date(dateString);

      // Corrige timezone [https://stackoverflow.com/a/16048201]
      date.setTime(date.getTime() + date.getTimezoneOffset() * 60 * 1_000);

      return date.toLocaleDateString();
    }

    function getEstados() {
      return [
        {
          "nome": "Acre",
          "sigla": "AC",
          "observacao": "Localizado na Região Norte"
        },
        {
          "nome": "Alagoas",
          "sigla": "AL",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Amapá",
          "sigla": "AP",
          "observacao": "Localizado na Região Norte"
        },
        {
          "nome": "Amazonas",
          "sigla": "AM",
          "observacao": "Localizado na Região Norte"
        },
        {
          "nome": "Bahia",
          "sigla": "BA",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Ceará",
          "sigla": "CE",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Distrito Federal",
          "sigla": "DF",
          "observacao": "Localizado na Região Centro-Oeste"
        },
        {
          "nome": "Espírito Santo",
          "sigla": "ES",
          "observacao": "Localizado na Região Sudeste"
        },
        {
          "nome": "Goiás",
          "sigla": "GO",
          "observacao": "Localizado na Região Centro-Oeste"
        },
        {
          "nome": "Maranhão",
          "sigla": "MA",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Mato Grosso",
          "sigla": "MT",
          "observacao": "Localizado na Região Centro-Oeste"
        },
        {
          "nome": "Mato Grosso do Sul",
          "sigla": "MS",
          "observacao": "Localizado na Região Centro-Oeste"
        },
        {
          "nome": "Minas Gerais",
          "sigla": "MG",
          "observacao": "Localizado na Região Sudeste"
        },
        {
          "nome": "Pará",
          "sigla": "PA",
          "observacao": "Localizado na Região Norte"
        },
        {
          "nome": "Paraíba",
          "sigla": "PB",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Paraná",
          "sigla": "PR",
          "observacao": "Localizado na Região Sul"
        },
        {
          "nome": "Pernambuco",
          "sigla": "PE",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Piauí",
          "sigla": "PI",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Rio de Janeiro",
          "sigla": "RJ",
          "observacao": "Localizado na Região Sudeste"
        },
        {
          "nome": "Rio Grande do Norte",
          "sigla": "RN",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Rio Grande do Sul",
          "sigla": "RS",
          "observacao": "Localizado na Região Sul"
        },
        {
          "nome": "Rondônia",
          "sigla": "RO",
          "observacao": "Localizado na Região Norte"
        },
        {
          "nome": "Roraima",
          "sigla": "RR",
          "observacao": "Localizado na Região Norte"
        },
        {
          "nome": "Santa Catarina",
          "sigla": "SC",
          "observacao": "Localizado na Região Sul"
        },
        {
          "nome": "São Paulo",
          "sigla": "SP",
          "observacao": "Localizado na Região Sudeste"
        },
        {
          "nome": "Sergipe",
          "sigla": "SE",
          "observacao": "Localizado na Região Nordeste"
        },
        {
          "nome": "Tocantins",
          "sigla": "TO",
          "observacao": "Localizado na Região Norte"
        }
      ]
    }
  </script>
</body>

</html>